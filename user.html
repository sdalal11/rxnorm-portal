<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RxNorm - Document Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }


        
        .auth-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .user-portal {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }
        
        .auth-header h2 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }
        
        .auth-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .auth-tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .auth-tab:hover {
            background-color: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: bold;
        }
        
        input[type="text"], input[type="email"], input[type="password"], select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 1rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-top: 1rem;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .error-message, .success-message {
            text-align: center;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            display: none;
        }
        
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .portal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }
        
        .welcome-text {
            color: #333;
        }
        
        .welcome-text h2 {
            color: #667eea;
            margin: 0;
        }
        
        .logout-btn {
            padding: 0.5rem 1rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .search-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        
        .search-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .search-group {
            flex: 1;
            min-width: 200px;
        }
        
        .search-btn {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .search-btn:hover {
            background: #5a6fd8;
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .document-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .document-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .document-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .document-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .document-meta {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 1rem;
        }
        
        .document-description {
            font-size: 0.875rem;
            color: #777;
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        
        .document-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }
        
        .btn-view {
            background: #17a2b8;
            color: white;
        }
        
        .btn-download {
            background: #28a745;
            color: white;
        }
        
        .btn-view:hover {
            background: #138496;
        }
        
        .btn-download:hover {
            background: #218838;
        }
        
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 12px;
            margin-bottom: 0.5rem;
        }
        
        .badge-general { background: #e3f2fd; color: #1976d2; }
        .badge-medical { background: #f3e5f5; color: #7b1fa2; }
        .badge-reports { background: #e8f5e8; color: #388e3c; }
        .badge-policies { background: #fff3e0; color: #f57c00; }
        .badge-training { background: #fce4ec; color: #c2185b; }
        .badge-research { background: #e0f2f1; color: #00796b; }
        
        .no-documents {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .no-documents h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .documents-grid {
                grid-template-columns: 1fr;
            }
            
            .search-controls {
                flex-direction: column;
            }
            
            .search-group {
                min-width: auto;
            }
        }

        .document-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000; /* Lower than annotations panel */
        }

        .viewer-content {
            position: relative;
            width: 90%;
            height: 90%;
            margin: 5% auto;
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }

        .viewer-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .viewer-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .viewer-toolbar {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .annotation-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-active {
            background: #28a745;
            color: white;
        }

        .btn-inactive {
            background: #dc3545;
            color: white;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
        }

        .btn-close {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }

        .annotation-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .viewer-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            position: relative;
        }

        .document-content {
            line-height: 1.6;
            font-size: 1rem;
            color: #333;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        .document-body-content {
            max-width: none !important;
            margin: 0 !important;
            padding: 1rem;
            line-height: 1.6;
            font-family: Arial, sans-serif;
        }

        .document-body-content * {
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }

        .document-content {
            cursor: text;
        }

        .document-content p, 
        .document-content div, 
        .document-content span {
            cursor: text;
        }

        /* Annotation styles */
        .highlight-active {
            background-color: #d4edda;
            border: 2px solid #28a745;
            border-radius: 3px;
            padding: 2px 4px;
            position: relative;
            cursor: pointer;
        }

        .highlight-inactive {
            background-color: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 3px;
            padding: 2px 4px;
            position: relative;
            cursor: pointer;
        }

        .highlight-active::after {
            content: "ACTIVE";
            position: absolute;
            top: -20px;
            left: 0;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .highlight-inactive::after {
            content: "INACTIVE";
            position: absolute;
            top: -20px;
            left: 0;
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 10;
        }

        .highlight-active:hover::after,
        .highlight-inactive:hover::after {
            opacity: 1;
        }

        .selection-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            display: none;
            z-index: 100;
        }

        .selection-popup button {
            margin: 0 0.25rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .annotations-panel {
            position: fixed;
            top: 10%;
            right: 20px;
            width: 300px;
            max-height: 70%;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1050; /* Higher than document viewer */
        }

        .annotations-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .annotations-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
        }

        .annotation-item {
            padding: 0.75rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .annotation-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .annotation-item:hover::before {
            content: "Click to locate in document";
            position: absolute;
            top: -30px;
            left: 0;
            background: #333;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0.9;
            z-index: 100;
        }

        .annotation-item:active {
            transform: translateX(0px);
            background: #e3f2fd;
        }

        .annotation-text {
            font-size: 0.875rem;
            color: #333;
            margin-bottom: 0.5rem;
            font-style: italic;
        }

        .annotation-status {
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #28a745;
        }

        .status-inactive {
            background: #f8d7da;
            color: #dc3545;
        }

        @media (max-width: 768px) {
            .viewer-content {
                width: 95%;
                height: 95%;
                margin: 2.5% auto;
            }
            
            .annotations-panel {
                position: fixed;
                top: auto;
                bottom: 20px;
                right: 20px;
                left: 20px;
                width: auto;
                max-height: 50%;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div class="auth-container" id="authContainer">
        <div class="auth-header">
            <h2>RxNorm Document Portal</h2>
            <p>Access medical documents and resources</p>
        </div>
        
        <!-- Auth Tabs -->
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="showAuthTab('login')">Login</div>
            <div class="auth-tab" onclick="showAuthTab('register')">Register</div>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="auth-form active">
            <form id="userLoginForm">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" name="password" required>
                </div>
                
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="auth-form">
            <form id="userRegisterForm">
                <div class="form-group">
                    <label for="registerName">Full Name:</label>
                    <input type="text" id="registerName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Password:</label>
                    <input type="password" id="registerPassword" name="password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password:</label>
                    <input type="password" id="registerConfirmPassword" name="confirmPassword" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="userRole">Role:</label>
                    <select id="userRole" name="role" required>
                        <option value="">Select your role</option>
                        <option value="doctor">Doctor</option>
                        <option value="nurse">Nurse</option>
                        <option value="pharmacist">Pharmacist</option>
                        <option value="researcher">Researcher</option>
                        <option value="student">Student</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">Create Account</button>
            </form>
        </div>
        
        <div class="error-message" id="authError">
            Invalid credentials. Please try again.
        </div>
        
        <div class="success-message" id="authSuccess">
            Account created successfully! You can now login.
        </div>
    </div>
    
    <!-- User Portal -->
    <div class="user-portal" id="userPortal">
        <div class="portal-header">
            <div class="welcome-text">
                <h2>Welcome, <span id="userName">User</span>!</h2>
                <p>Browse and access medical documents</p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- Stats Section -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-number" id="totalDocsCount">0</div>
                <div class="stat-label">Total Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="categoriesCount">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="recentCount">0</div>
                <div class="stat-label">Recent Uploads</div>
            </div>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="search-section">
            <h3>Find Documents</h3>
            <div class="search-controls">
                <div class="search-group">
                    <label for="searchQuery">Search:</label>
                    <input type="text" id="searchQuery" placeholder="Search documents...">
                </div>
                <div class="search-group">
                    <label for="filterCategory">Category:</label>
                    <select id="filterCategory">
                        <option value="">All Categories</option>
                        <option value="general">General</option>
                        <option value="medical">Medical Records</option>
                        <option value="reports">Reports</option>
                        <option value="policies">Policies</option>
                        <option value="training">Training Materials</option>
                        <option value="research">Research Documents</option>
                    </select>
                </div>
                <button class="search-btn" onclick="filterDocuments()">Search</button>
                <button class="search-btn btn-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>
        
        <!-- Documents Grid -->
        <div id="documentsContainer">
            <h3>Available Documents</h3>
            <div class="documents-grid" id="documentsGrid">
                <!-- Documents will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add this HTML after the user portal div (around line 420): -->

    <!-- Document Viewer Modal -->
    <div class="document-viewer" id="documentViewer">
        <div class="viewer-content">
            <div class="viewer-header">
                <div class="viewer-title" id="viewerTitle">Document Viewer</div>
               <div class="viewer-toolbar">
                    <button class="annotation-btn btn-active" onclick="markAsActive()" id="activeBtn">
                        Mark as Active
                    </button>
                    <button class="annotation-btn btn-inactive" onclick="markAsInactive()" id="inactiveBtn">
                        Mark as Inactive
                    </button>
                    <button class="annotation-btn btn-clear" onclick="clearSelection()">
                        Clear Selection
                    </button>
                    <button class="annotation-btn" onclick="toggleAnnotationsPanel()" style="background: #17a2b8; color: white;">
                        Show Annotations (<span id="annotationCount">0</span>)
                    </button>
                    <button class="annotation-btn" onclick="saveAnnotations()" style="background: #28a745; color: white;">
                        Save
                    </button>
                    <button class="annotation-btn btn-close" onclick="closeViewer()">
                        Close
                    </button>
                </div>
            </div>
            <div class="viewer-body">
                <div class="document-content" id="documentContent">
                    <!-- Document content will be loaded here -->
                </div>
                <div class="selection-popup" id="selectionPopup">
                    <button class="btn-active" onclick="annotateSelection('active')">Active</button>
                    <button class="btn-inactive" onclick="annotateSelection('inactive')">Inactive</button>
                    <button class="btn-clear" onclick="hideSelectionPopup()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Annotations Panel -->
    <div class="annotations-panel" id="annotationsPanel">
        <div class="annotations-header">
            <h4 style="margin: 0;">Document Annotations</h4>
            <button onclick="toggleAnnotationsPanel()" style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button>
        </div>
        <div class="annotations-list" id="annotationsList">
            <!-- Annotations will be listed here -->
        </div>
    </div>
    
    <script>
        // User data storage
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || [];
        let currentUser = null;
        let allDocuments = [];
        let filteredDocuments = [];
        
        // Authentication functions
        function showAuthTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show correct form
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(tabName + 'Form').classList.add('active');
            
            // Clear messages
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }
        
        // Login form handler
        document.getElementById('userLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = registeredUsers.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                showUserPortal();
            } else {
                document.getElementById('authError').textContent = 'Invalid email or password.';
                document.getElementById('authError').style.display = 'block';
            }
        });
        
        // Register form handler
        document.getElementById('userRegisterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const role = document.getElementById('userRole').value;
            
            // Validation
            if (password !== confirmPassword) {
                document.getElementById('authError').textContent = 'Passwords do not match.';
                document.getElementById('authError').style.display = 'block';
                return;
            }
            
            if (registeredUsers.find(u => u.email === email)) {
                document.getElementById('authError').textContent = 'Email already registered.';
                document.getElementById('authError').style.display = 'block';
                return;
            }
            
            // Create new user
            const newUser = {
                id: Date.now(),
                name: name,
                email: email,
                password: password, // In production, this should be hashed
                role: role,
                registeredDate: new Date().toISOString()
            };
            
            registeredUsers.push(newUser);
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            
            // Show success message and switch to login
            document.getElementById('authSuccess').style.display = 'block';
            document.getElementById('authError').style.display = 'none';
            
            // Clear form
            document.getElementById('userRegisterForm').reset();
            
            // Switch to login tab after 2 seconds
            setTimeout(() => {
                showAuthTab('login');
                document.getElementById('loginEmail').value = email;
            }, 2000);
        });
        
        function showUserPortal() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userPortal').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            
            loadDocuments();
            updateStats();
        }
        
        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('userPortal').style.display = 'none';
            
            // Clear forms
            document.getElementById('userLoginForm').reset();
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }
        
        // Document functions
        function loadDocuments() {
            // Load documents from admin's localStorage (simulating shared storage)
            const adminDocuments = JSON.parse(localStorage.getItem('documentsData')) || [];
            
            // Filter only public documents
            allDocuments = adminDocuments.filter(doc => doc.publicAccess === true);
            filteredDocuments = [...allDocuments];
            
            displayDocuments();
        }
        
        function displayDocuments() {
            const documentsGrid = document.getElementById('documentsGrid');
            
            if (filteredDocuments.length === 0) {
                documentsGrid.innerHTML = `
                    <div class="no-documents">
                        <h3>No Documents Found</h3>
                        <p>No documents are currently available or match your search criteria.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredDocuments.forEach(doc => {
                const icon = getDocumentIcon(doc.name);
                const badgeClass = `badge-${doc.category}`;
                
                html += `
                    <div class="document-card" onclick="viewDocument('${doc.id}')">
                        <div class="document-icon">${icon}</div>
                        <div class="category-badge ${badgeClass}">${doc.category.toUpperCase()}</div>
                        <div class="document-title">${doc.name}</div>
                        <div class="document-meta">
                            Uploaded: ${doc.uploadDate}<br>
                            Size: ${doc.size}
                        </div>
                        ${doc.description ? `<div class="document-description">${doc.description}</div>` : ''}
                        <div class="document-actions">
                            <button class="btn-small btn-view" onclick="event.stopPropagation(); viewDocument('${doc.id}')">View</button>
                            <button class="btn-small btn-download" onclick="event.stopPropagation(); downloadDocument('${doc.id}')">Download</button>
                        </div>
                    </div>
                `;
            });
            
            documentsGrid.innerHTML = html;
        }
        
        function getDocumentIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': '📄',
                'doc': '📝',
                'docx': '📝',
                'html': '🌐',
                'htm': '🌐',
                'txt': '📄',
                'jpg': '🖼️',
                'jpeg': '🖼️',
                'png': '🖼️',
                'xlsx': '📊',
                'pptx': '📽️'
            };
            return icons[ext] || '📁';
        }
        
        function filterDocuments() {
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            
            filteredDocuments = allDocuments.filter(doc => {
                const matchesSearch = !searchQuery || 
                    doc.name.toLowerCase().includes(searchQuery) || 
                    (doc.description && doc.description.toLowerCase().includes(searchQuery));
                
                const matchesCategory = !categoryFilter || doc.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });
            
            displayDocuments();
        }
        
        function clearFilters() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('filterCategory').value = '';
            filteredDocuments = [...allDocuments];
            displayDocuments();
        }
        
        
        function downloadDocument(docId) {
            const doc = allDocuments.find(d => d.id == docId);
            if (doc) {
                // In production, this would trigger download from Azure
                alert(`Downloading: ${doc.name}\nAzure URL: ${doc.azureUrl}`);
            }
        }
        
        function updateStats() {
            document.getElementById('totalDocsCount').textContent = allDocuments.length;
            
            const categories = [...new Set(allDocuments.map(doc => doc.category))];
            document.getElementById('categoriesCount').textContent = categories.length;
            
            // Recent uploads (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentDocs = allDocuments.filter(doc => 
                new Date(doc.uploadDate) > thirtyDaysAgo
            );
            document.getElementById('recentCount').textContent = recentDocs.length;
        }
        
        // Search on Enter key
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterDocuments();
            }
        });
        
        // Check if user is already logged in
        window.addEventListener('load', function() {
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showUserPortal();
            }
        });
    </script>

    <script>
        // Annotation functionality
        let currentDocument = null;
        let documentAnnotations = [];
        let currentAnnotationMode = 'active';
        let selectedRange = null;

        // Update the viewDocument function
        function viewDocument(docId) {
            const doc = allDocuments.find(d => d.id == docId);
            if (doc) {
                currentDocument = doc;
                openDocumentViewer(doc);
            }
        }

        // Replace the openDocumentViewer function (around line 1120) with this:
        async function openDocumentViewer(doc) {
            document.getElementById('documentViewer').style.display = 'block';
            document.getElementById('viewerTitle').textContent = doc.name;
            
            try {
                // Load document content
                const content = await loadDocumentContent(doc);
                document.getElementById('documentContent').innerHTML = content;
                
                // Important: Wait a bit for content to render, then load annotations
                setTimeout(() => {
                    loadDocumentAnnotations(doc.id);
                    updateAnnotationCount();
                    updateAnnotationsList();
                }, 100);
                
            } catch (error) {
                console.error('Error loading document:', error);
                document.getElementById('documentContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h3>Unable to load document content</h3>
                        <p>This document format cannot be displayed for annotation.</p>
                        <p><strong>Document:</strong> ${doc.name}</p>
                        <p><strong>Size:</strong> ${doc.size}</p>
                        <button onclick="window.open('${doc.azureUrl}', '_blank')" class="annotation-btn" style="background: #667eea; color: white;">
                            Open Original Document
                        </button>
                    </div>
                `;
            }
        }

       // Replace the loadDocumentContent function (lines 1139-1212) with this:
        async function loadDocumentContent(doc) {
            const fileExtension = doc.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'html' || fileExtension === 'htm') {
                try {
                    // Get Azure config from localStorage
                    const adminConfigData = localStorage.getItem('azureConfigPublic') || localStorage.getItem('azureConfig');
                    
                    if (!adminConfigData) {
                        throw new Error('Azure configuration not found. Please contact administrator to configure Azure access.');
                    }
                    
                    const adminConfig = JSON.parse(adminConfigData);
                    
                    if (!adminConfig.sasToken || !adminConfig.storageAccount || !adminConfig.containerName) {
                        throw new Error('Incomplete Azure configuration. Please contact administrator.');
                    }
                    
                    // Construct the Azure blob URL with SAS token
                    const blobUrl = `https://${adminConfig.storageAccount}.blob.core.windows.net/${adminConfig.containerName}/${doc.blobName}${adminConfig.sasToken}`;
                    
                    console.log('Fetching document from:', blobUrl);
                    
                    // Fetch the actual HTML content from Azure
                    const response = await fetch(blobUrl, {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch document: ${response.status} ${response.statusText}`);
                    }
                    
                    // Get the HTML content
                    const htmlContent = await response.text();
                    
                    console.log('Document content loaded successfully');
                    
                    // Extract only the body content to avoid nested HTML structure
                    const parser = new DOMParser();
                    const parsedDoc = parser.parseFromString(htmlContent, 'text/html');
                    
                    // Get the body content, or fall back to the entire content if no body tag
                    const bodyContent = parsedDoc.body ? parsedDoc.body.innerHTML : htmlContent;
                    
                    // Return the extracted content wrapped in a div for proper annotation handling
                    return `<div class="document-body-content">${bodyContent}</div>`;
                    
                } catch (error) {
                    console.error('Error fetching document from Azure:', error);
                    
                    // Fallback to showing error message with link to original
                    return `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <h3>Unable to load document content</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p><strong>Document:</strong> ${doc.name}</p>
                            <p><strong>Size:</strong> ${doc.size}</p>
                            <button onclick="window.open('${doc.azureUrl}', '_blank')" class="annotation-btn" style="background: #667eea; color: white;">
                                Open Original Document in New Tab
                            </button>
                        </div>
                    `;
                }
            } else {
                // For non-HTML files, show a preview message
                return `
                    <div style="text-align: center; padding: 2rem;">
                        <h3>Document Preview: ${doc.name}</h3>
                        <p>This is a ${fileExtension.toUpperCase()} file. Annotation is currently only supported for HTML documents.</p>
                        <p>You can view the original document by clicking the button below.</p>
                        <br>
                        <button onclick="window.open('${doc.azureUrl}', '_blank')" class="annotation-btn" style="background: #667eea; color: white;">
                            Open Original Document
                        </button>
                    </div>
                `;
            }
        }

        // Replace the loadDocumentAnnotations function with this Azure-enabled version:
        async function loadDocumentAnnotations(docId) {
            console.log('🔄 Loading annotations for document:', docId);
            
            // Initialize
            documentAnnotations = [];
            
            // Try to load from Azure first, then fallback to localStorage
            if (currentUser) {
                try {
                    await loadAnnotationsFromAzure(docId);
                } catch (error) {
                    console.warn('⚠️ Failed to load from Azure, using localStorage:', error);
                    loadAnnotationsFromLocalStorage(docId);
                }
            } else {
                loadAnnotationsFromLocalStorage(docId);
            }
            
            // Load pre-annotations from document (AI-generated)
            const doc = allDocuments.find(d => d.id == docId);
            if (doc && doc.preAnnotations && doc.preAnnotations.length > 0) {
                console.log(`🤖 Found ${doc.preAnnotations.length} pre-annotations`);
                
                // Convert pre-annotations to our annotation format
                const preAnnotations = doc.preAnnotations.map((preAnn, index) => {
                    // Handle both string and object formats
                    let cleanText = preAnn.text || preAnn.normalized_name || preAnn.medication || String(preAnn);
                    
                    return {
                        id: 'pre_' + Date.now() + '_' + index,
                        text: cleanText.trim(),
                        status: preAnn.active_status || preAnn.status || 'active',
                        timestamp: new Date().toISOString(),
                        source: 'main.py',
                        confidence: preAnn.confidence || 0.9,
                        rxnorm_code: preAnn.rx_cui || preAnn.rxnorm_code,
                        isPreAnnotation: true
                    };
                });
                
                // Merge with user annotations (user annotations take precedence)
                const userTexts = documentAnnotations.map(ann => ann.text);
                const uniquePreAnnotations = preAnnotations.filter(
                    preAnn => !userTexts.includes(preAnn.text)
                );
                
                documentAnnotations = [...documentAnnotations, ...uniquePreAnnotations];
                console.log(`📊 Total annotations: ${documentAnnotations.length} (${uniquePreAnnotations.length} from AI)`);
            }
            
            // Apply all annotations to the document
            setTimeout(() => {
                console.log('🎨 Applying annotations to document...');
                documentAnnotations.forEach((annotation, index) => {
                    console.log(`🎯 ${index + 1}. Highlighting: "${annotation.text}" as ${annotation.status}`);
                    highlightText(annotation.text, annotation.status, false);
                });
                console.log(`✅ Applied ${documentAnnotations.length} annotations`);
                updateAnnotationCount();

            }, 1000);
        }

        // Add helper functions for Azure loading:
        async function loadAnnotationsFromAzure(docId) {
            if (!currentUser) return;
            
            try {
                const adminConfigData = localStorage.getItem('azureConfigPublic') || localStorage.getItem('azureConfig');
                if (!adminConfigData) {
                    throw new Error('Azure configuration not found');
                }
                
                const azureConfig = JSON.parse(adminConfigData);
                const userFolder = currentUser.email.replace(/[@.]/g, '_');
                const doc = allDocuments.find(d => d.id == docId);
                const fileName = `${docId}_${doc.name.replace(/[^a-zA-Z0-9]/g, '_')}_annotations.json`;
                const blobName = `${userFolder}/annotations/${fileName}`;
                
                const blobUrl = `https://${azureConfig.storageAccount}.blob.core.windows.net/${azureConfig.containerName}/${blobName}${azureConfig.sasToken}`;
                
                console.log('📥 Loading annotations from Azure:', blobUrl);
                
                const response = await fetch(blobUrl, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.status === 404) {
                    console.log('ℹ️ No saved annotations found in Azure for this document');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`Failed to load from Azure: ${response.status}`);
                }
                
                const annotationData = await response.json();
                
                if (annotationData.annotations && Array.isArray(annotationData.annotations)) {
                    // Filter out pre-annotations (they'll be loaded separately)
                    documentAnnotations = annotationData.annotations.filter(ann => !ann.isPreAnnotation);
                    console.log(`✅ Loaded ${documentAnnotations.length} user annotations from Azure`);
                }
                
            } catch (error) {
                console.error('❌ Error loading from Azure:', error);
                throw error; // Re-throw to trigger fallback
            }
        }

        function loadAnnotationsFromLocalStorage(docId) {
            const savedAnnotations = JSON.parse(localStorage.getItem('documentAnnotations')) || {};
            const localAnnotations = savedAnnotations[docId] || [];
            
            // Filter out pre-annotations (they'll be loaded separately)
            documentAnnotations = localAnnotations.filter(ann => !ann.isPreAnnotation);
            console.log(`📦 Loaded ${documentAnnotations.length} user annotations from localStorage`);
        }


        function setAnnotationMode(mode) {
            currentAnnotationMode = mode;
            
            // Update button states
            document.getElementById('activeBtn').style.opacity = mode === 'active' ? '1' : '0.6';
            document.getElementById('inactiveBtn').style.opacity = mode === 'inactive' ? '1' : '0.6';
        }

        // Text selection and annotation
        // Replace the mouseup event listener (around line 1285) with this improved version:
        document.addEventListener('mouseup', function(e) {
    // Check if we're in the document viewer
            const documentViewer = document.getElementById('documentViewer');
            if (documentViewer.style.display !== 'block') return;
            
            // Small delay to ensure selection is complete
            setTimeout(() => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();
                
                if (selectedText.length > 0 && selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const documentContent = document.getElementById('documentContent');
                    
                    // Check if the selection is within the document content
                    if (documentContent && (
                        documentContent.contains(range.commonAncestorContainer) || 
                        documentContent.contains(range.startContainer) ||
                        documentContent.contains(range.endContainer)
                    )) {
                        selectedRange = range;
                        console.log('Text selected:', selectedText); // Debug log
                        showSelectionPopup(e.pageX, e.pageY);
                    }
                } else {
                    hideSelectionPopup();
                }
            }, 10);
        });

        // Replace the showSelectionPopup function (around line 1320) with this:


        function hideSelectionPopup() {
            document.getElementById('selectionPopup').style.display = 'none';
            selectedRange = null;
        }

        // Add this function after the hideSelectionPopup function:
        function showSelectionPopup(x, y) {
            const popup = document.getElementById('selectionPopup');
            if (popup) {
                popup.style.display = 'block';
                
                // Improve positioning to stay within viewport
                const popupWidth = 200;
                const popupHeight = 60;
                
                const adjustedX = Math.min(x, window.innerWidth - popupWidth);
                const adjustedY = Math.max(y - popupHeight, 10);
                
                popup.style.left = adjustedX + 'px';
                popup.style.top = adjustedY + 'px';
                popup.style.zIndex = '1001';
                
                console.log('Showing selection popup at:', adjustedX, adjustedY); // Debug log
            }
        }

        // Replace the annotateSelection function (around line 1350) with this:
        function annotateSelection(status) {
            if (!selectedRange) return;
            
            const selectedText = selectedRange.toString().trim();
            if (selectedText.length === 0) return;
            
            console.log('Annotating selection:', selectedText, 'as', status); // Debug log
            
            // Create annotation
            const annotation = {
                id: Date.now(),
                text: selectedText,
                status: status,
                timestamp: new Date().toISOString(),
                position: selectedRange.startOffset,
                source: 'user',
                isPreAnnotation: false
            };
            
            // Add to annotations array
            documentAnnotations.push(annotation);
            
            // Highlight the text with the specific range
            highlightText(selectedText, status, true, selectedRange.cloneRange());
            
            // Clear selection
            window.getSelection().removeAllRanges();
            hideSelectionPopup();
            
            // Update annotation count and list
            updateAnnotationCount();
            updateAnnotationsList();
            
            console.log('Annotation created:', annotation); // Debug log
        }

        function highlightText(text, status, isNew = false, range = null) {
            console.log('highlightText called:', { text, status, isNew });
            
            const content = document.getElementById('documentContent');
            if (!content) {
                console.error('Document content not found');
                return;
            }
            
            const className = status === 'active' ? 'highlight-active' : 'highlight-inactive';
            
            // If we have a specific range (new annotation), use it
            if (isNew && range) {
                try {
                    const span = document.createElement('span');
                    span.className = className;
                    span.onclick = () => removeAnnotation(text, status);
                    range.surroundContents(span);
                    console.log('Range highlighting successful');
                    return;
                } catch (error) {
                    console.log('Range highlighting failed, falling back to text search');
                }
            }
            
            // Text search method for loading saved annotations
            const walker = document.createTreeWalker(
                content,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                textNodes.push(node);
            }
            
            console.log(`Found ${textNodes.length} text nodes`);
            
            // Look for the text in all text nodes
            for (let textNode of textNodes) {
                const parent = textNode.parentNode;
                
                // Skip already highlighted text
                if (parent.classList.contains('highlight-active') || parent.classList.contains('highlight-inactive')) {
                    continue;
                }
                
                const nodeText = textNode.textContent;
                const index = nodeText.indexOf(text);
                
                if (index !== -1) {
                    console.log(`Found text "${text}" in node:`, nodeText);
                    
                    const beforeText = nodeText.substring(0, index);
                    const matchText = nodeText.substring(index, index + text.length);
                    const afterText = nodeText.substring(index + text.length);
                    
                    const span = document.createElement('span');
                    span.className = className;
                    span.textContent = matchText;
                    span.onclick = () => removeAnnotation(text, status);
                    span.style.backgroundColor = status === 'active' ? '#d4edda' : '#f8d7da';
                    span.style.border = `2px solid ${status === 'active' ? '#28a745' : '#dc3545'}`;
                    span.style.borderRadius = '3px';
                    span.style.padding = '2px 4px';
                    
                    const fragment = document.createDocumentFragment();
                    if (beforeText) fragment.appendChild(document.createTextNode(beforeText));
                    fragment.appendChild(span);
                    if (afterText) fragment.appendChild(document.createTextNode(afterText));
                    
                    parent.replaceChild(fragment, textNode);
                    console.log(`Successfully highlighted: "${text}"`);
                    break; // Only highlight first occurrence
                }
            }
        }

        function removeAnnotation(text, status) {
            if (confirm('Remove this annotation?')) {
                // Remove from annotations array
                documentAnnotations = documentAnnotations.filter(ann => 
                    !(ann.text === text && ann.status === status)
                );
                
                // Refresh the document display
                refreshDocumentDisplay();
                updateAnnotationCount();
                updateAnnotationsList();
            }
        }

        // Replace the markAsActive and markAsInactive functions with these improved versions:
        function markAsActive() {
            console.log('Mark as Active clicked');
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0 && selection.rangeCount > 0) {
                selectedRange = selection.getRangeAt(0).cloneRange(); // Clone the range
                annotateSelection('active');
            } else {
                alert('Please select some text first');
            }
        }

        function markAsInactive() {
            console.log('Mark as Inactive clicked');
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0 && selection.rangeCount > 0) {
                selectedRange = selection.getRangeAt(0).cloneRange(); // Clone the range
                annotateSelection('inactive');
            } else {
                alert('Please select some text first');
            }
        }

    

        function refreshDocumentDisplay() {
            if (currentDocument) {
                openDocumentViewer(currentDocument);
            }
        }

        function clearSelection() {
            window.getSelection().removeAllRanges();
            hideSelectionPopup();
        }

        // Replace the updateAnnotationCount function (around line 1450) with this fixed version:
        function updateAnnotationCount() {
            // Make sure documentAnnotations is an array, not an object
            if (!Array.isArray(documentAnnotations)) {
                documentAnnotations = [];
            }
            
            const count = documentAnnotations.length;
            console.log('📊 Updating annotation count:', count, 'annotations:', documentAnnotations);
            
            const countElement = document.getElementById('annotationCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // function updateAnnotationsList() {
        //     const list = document.getElementById('annotationsList');
            
        //     if (documentAnnotations.length === 0) {
        //         list.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">No annotations yet</p>';
        //         return;
        //     }
            
        //     let html = '';
        //     documentAnnotations.forEach((annotation, index) => {
        //         const statusClass = annotation.status === 'active' ? 'status-active' : 'status-inactive';
        //         const sourceIcon = annotation.isPreAnnotation ? '🤖' : '👤';
        //         const sourceText = annotation.isPreAnnotation ? 'AI Detected' : 'User Added';
        //         const confidenceText = annotation.confidence ? ` (${Math.round(annotation.confidence * 100)}%)` : '';
                
        //         html += `
        //             <div class="annotation-item" onclick="scrollToAnnotation('${annotation.text}')">
        //                 <div class="annotation-text">"${annotation.text.substring(0, 50)}${annotation.text.length > 50 ? '...' : ''}"</div>
        //                 <div class="annotation-status ${statusClass}">${annotation.status.toUpperCase()}</div>
        //                 <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
        //                     ${sourceIcon} ${sourceText}${confidenceText}
        //                     <br>${new Date(annotation.timestamp).toLocaleString()}
        //                     ${annotation.rxnorm_code ? `<br>RxNorm: ${annotation.rxnorm_code}` : ''}
        //                 </div>
        //                 ${annotation.isPreAnnotation ? 
        //                     `<div style="margin-top: 0.5rem; display: flex; gap: 0.25rem; flex-wrap: wrap;">
        //                         <button onclick="event.stopPropagation(); changeAnnotationStatus('${annotation.id}', 'active')" 
        //                                 style="padding: 0.25rem 0.5rem; background: ${annotation.status === 'active' ? '#28a745' : '#6c757d'}; 
        //                                     color: white; border: none; border-radius: 3px; font-size: 0.7rem; flex: 1;">
        //                             ${annotation.status === 'active' ? '✓ Active' : 'Set Active'}
        //                         </button>
        //                         <button onclick="event.stopPropagation(); changeAnnotationStatus('${annotation.id}', 'inactive')" 
        //                                 style="padding: 0.25rem 0.5rem; background: ${annotation.status === 'inactive' ? '#dc3545' : '#6c757d'}; 
        //                                     color: white; border: none; border-radius: 3px; font-size: 0.7rem; flex: 1;">
        //                             ${annotation.status === 'inactive' ? '✓ Inactive' : 'Set Inactive'}
        //                         </button>
        //                         <button onclick="event.stopPropagation(); convertToUserAnnotation('${annotation.id}')" 
        //                                 style="padding: 0.25rem 0.5rem; background: #007bff; color: white; border: none; 
        //                                     border-radius: 3px; font-size: 0.7rem; width: 100%; margin-top: 0.25rem;">
        //                             Confirm AI Detection
        //                         </button>
        //                     </div>` : 
        //                     `<div style="margin-top: 0.5rem; display: flex; gap: 0.25rem;">
        //                         <button onclick="event.stopPropagation(); changeAnnotationStatus('${annotation.id}', '${annotation.status === 'active' ? 'inactive' : 'active'}')" 
        //                                 style="padding: 0.25rem 0.5rem; background: #6c757d; color: white; border: none; 
        //                                     border-radius: 3px; font-size: 0.7rem; flex: 1;">
        //                             Change to ${annotation.status === 'active' ? 'Inactive' : 'Active'}
        //                         </button>
        //                         <button onclick="event.stopPropagation(); removeAnnotationById('${annotation.id}')" 
        //                                 style="padding: 0.25rem 0.5rem; background: #dc3545; color: white; border: none; 
        //                                     border-radius: 3px; font-size: 0.7rem;">
        //                             Remove
        //                         </button>
        //                     </div>`
        //                 }
        //             </div>
        //         `;
        //     });
            
        //     list.innerHTML = html;
        // }

        // Replace the updateAnnotationsList function with this enhanced version that passes the full text:
        function updateAnnotationsList() {
            const list = document.getElementById('annotationsList');
            
            if (documentAnnotations.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem;">No annotations yet</p>';
                return;
            }
            
            let html = '';
            documentAnnotations.forEach((annotation, index) => {
                const statusClass = annotation.status === 'active' ? 'status-active' : 'status-inactive';
                const sourceIcon = annotation.isPreAnnotation ? '🤖' : '👤';
                const sourceText = annotation.isPreAnnotation ? 'AI Detected' : 'User Added';
                const confidenceText = annotation.confidence ? ` (${Math.round(annotation.confidence * 100)}%)` : '';
                
                // Escape quotes for onclick attribute
                const escapedText = annotation.text.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const displayText = annotation.text.length > 50 ? 
                    annotation.text.substring(0, 50) + '...' : 
                    annotation.text;
                
                html += `
                    <div class="annotation-item" onclick="scrollToAnnotation('${escapedText}')" style="cursor: pointer; transition: background-color 0.2s;">
                        <div class="annotation-text" title="${annotation.text}">
                            <strong>"${displayText}"</strong>
                        </div>
                        <div class="annotation-status ${statusClass}">${annotation.status.toUpperCase()}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                            ${sourceIcon} ${sourceText}${confidenceText}
                            <br>${new Date(annotation.timestamp).toLocaleString()}
                            ${annotation.rxnorm_code ? `<br>RxNorm: ${annotation.rxnorm_code}` : ''}
                        </div>
                        ${annotation.isPreAnnotation ? 
                            `<div style="margin-top: 0.5rem; display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                <button onclick="event.stopPropagation(); changeAnnotationStatus('${annotation.id}', 'active')" 
                                        style="padding: 0.25rem 0.5rem; background: ${annotation.status === 'active' ? '#28a745' : '#6c757d'}; 
                                            color: white; border: none; border-radius: 3px; font-size: 0.7rem; flex: 1;">
                                    ${annotation.status === 'active' ? '✓ Active' : 'Set Active'}
                                </button>
                                <button onclick="event.stopPropagation(); changeAnnotationStatus('${annotation.id}', 'inactive')" 
                                        style="padding: 0.25rem 0.5rem; background: ${annotation.status === 'inactive' ? '#dc3545' : '#6c757d'}; 
                                            color: white; border: none; border-radius: 3px; font-size: 0.7rem; flex: 1;">
                                    ${annotation.status === 'inactive' ? '✓ Inactive' : 'Set Inactive'}
                                </button>
                                <button onclick="event.stopPropagation(); convertToUserAnnotation('${annotation.id}')" 
                                        style="padding: 0.25rem 0.5rem; background: #007bff; color: white; border: none; 
                                            border-radius: 3px; font-size: 0.7rem; width: 100%; margin-top: 0.25rem;">
                                    Confirm AI Detection
                                </button>
                            </div>` : 
                            `<div style="margin-top: 0.5rem; display: flex; gap: 0.25rem;">
                                <button onclick="event.stopPropagation(); changeAnnotationStatus('${annotation.id}', '${annotation.status === 'active' ? 'inactive' : 'active'}')" 
                                        style="padding: 0.25rem 0.5rem; background: #6c757d; color: white; border: none; 
                                            border-radius: 3px; font-size: 0.7rem; flex: 1;">
                                    Change to ${annotation.status === 'active' ? 'Inactive' : 'Active'}
                                </button>
                                <button onclick="event.stopPropagation(); removeAnnotationById('${annotation.id}')" 
                                        style="padding: 0.25rem 0.5rem; background: #dc3545; color: white; border: none; 
                                            border-radius: 3px; font-size: 0.7rem;">
                                    Remove
                                </button>
                            </div>`
                        }
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

        // Add this new function after the updateAnnotationsList function:
        // function convertToUserAnnotation(annotationId) {
        //     const annotation = documentAnnotations.find(ann => ann.id === annotationId);
        //     if (annotation) {
        //         annotation.isPreAnnotation = false;
        //         annotation.source = 'user';
        //         annotation.timestamp = new Date().toISOString();
        //         updateAnnotationsList();
                
        //         // Save the updated annotations
        //         const allAnnotations = JSON.parse(localStorage.getItem('documentAnnotations')) || {};
        //         allAnnotations[currentDocument.id] = documentAnnotations;
        //         localStorage.setItem('documentAnnotations', JSON.stringify(allAnnotations));
                
        //         console.log('Converted AI annotation to user annotation:', annotation);
        //     }
        // }

        // // Add these new functions after the convertToUserAnnotation function:

        // function changeAnnotationStatus(annotationId, newStatus) {
        //     const annotation = documentAnnotations.find(ann => ann.id === annotationId);
        //     if (annotation && annotation.status !== newStatus) {
        //         const oldStatus = annotation.status;
        //         annotation.status = newStatus;
        //         annotation.timestamp = new Date().toISOString();
                
        //         console.log(`Changed annotation "${annotation.text}" from ${oldStatus} to ${newStatus}`);
                
        //         // Re-highlight the text with new status
        //         rehighlightAnnotation(annotation, oldStatus);
                
        //         // Update the display
        //         updateAnnotationsList();
        //         updateAnnotationCount();
                
        //         // Save if it's a user annotation
        //         if (!annotation.isPreAnnotation) {
        //             saveAnnotationsToStorage();
        //         }
        //     }
        // }

        // Update the convertToUserAnnotation and changeAnnotationStatus functions to auto-save:
        function convertToUserAnnotation(annotationId) {
            const annotation = documentAnnotations.find(ann => ann.id === annotationId);
            if (annotation) {
                annotation.isPreAnnotation = false;
                annotation.source = 'user';
                annotation.timestamp = new Date().toISOString();
                updateAnnotationsList();
                
                // Auto-save to Azure
                autoSaveAnnotations();
                
                console.log('✅ Converted AI annotation to user annotation:', annotation);
            }
        }

        function changeAnnotationStatus(annotationId, newStatus) {
            const annotation = documentAnnotations.find(ann => ann.id === annotationId);
            if (annotation && annotation.status !== newStatus) {
                const oldStatus = annotation.status;
                annotation.status = newStatus;
                annotation.timestamp = new Date().toISOString();
                
                console.log(`🔄 Changed annotation "${annotation.text}" from ${oldStatus} to ${newStatus}`);
                
                // Re-highlight the text with new status
                rehighlightAnnotation(annotation, oldStatus);
                
                // Update the display
                updateAnnotationsList();
                updateAnnotationCount();
                
                // Auto-save to Azure
                autoSaveAnnotations();
            }
        }

        // Add auto-save with debouncing:
        let autoSaveTimeout;
        async function autoSaveAnnotations() {
            // Clear previous timeout
            clearTimeout(autoSaveTimeout);
            
            // Set new timeout to auto-save after 3 seconds of no changes
            autoSaveTimeout = setTimeout(async () => {
                try {
                    await saveAnnotationsToAzure();
                    console.log('💾 Auto-saved annotations to Azure');
                    
                    // Show subtle indicator
                    const indicator = document.createElement('div');
                    indicator.textContent = '☁️ Auto-saved';
                    indicator.style.cssText = `
                        position: fixed; top: 20px; right: 20px; 
                        background: #28a745; color: white; 
                        padding: 0.5rem 1rem; border-radius: 6px; 
                        font-size: 0.875rem; z-index: 1100;
                        opacity: 0; transition: opacity 0.3s;
                    `;
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => indicator.style.opacity = '1', 100);
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                        setTimeout(() => document.body.removeChild(indicator), 300);
                    }, 2000);
                    
                } catch (error) {
                    console.warn('⚠️ Auto-save failed, saving to localStorage:', error);
                    saveAnnotationsToStorage(); // Fallback to localStorage
                }
            }, 3000); // 3 second delay
        }

        // Add helper function for just Azure save (without UI feedback):
        async function saveAnnotationsToAzure() {
            if (!currentDocument || !currentUser) return;
            
            const adminConfigData = localStorage.getItem('azureConfigPublic') || localStorage.getItem('azureConfig');
            if (!adminConfigData) {
                throw new Error('Azure configuration not found');
            }
            
            const azureConfig = JSON.parse(adminConfigData);
            
            const annotationData = {
                documentId: currentDocument.id,
                documentName: currentDocument.name,
                documentBlobName: currentDocument.blobName,
                userEmail: currentUser.email,
                userName: currentUser.name,
                userRole: currentUser.role,
                annotations: documentAnnotations,
                lastModified: new Date().toISOString(),
                version: "1.0",
                statistics: {
                    totalAnnotations: documentAnnotations.length,
                    activeCount: documentAnnotations.filter(ann => ann.status === 'active').length,
                    inactiveCount: documentAnnotations.filter(ann => ann.status === 'inactive').length,
                    aiGeneratedCount: documentAnnotations.filter(ann => ann.isPreAnnotation).length,
                    userCreatedCount: documentAnnotations.filter(ann => !ann.isPreAnnotation).length
                }
            };
            
            const userFolder = currentUser.email.replace(/[@.]/g, '_');
            const fileName = `${currentDocument.id}_${currentDocument.name.replace(/[^a-zA-Z0-9]/g, '_')}_annotations.json`;
            const blobName = `${userFolder}/annotations/${fileName}`;
            
            const blobUrl = `https://${azureConfig.storageAccount}.blob.core.windows.net/${azureConfig.containerName}/${blobName}${azureConfig.sasToken}`;
            
            const response = await fetch(blobUrl, {
                method: 'PUT',
                headers: {
                    'x-ms-blob-type': 'BlockBlob',
                    'Content-Type': 'application/json',
                    'x-ms-meta-user': currentUser.email,
                    'x-ms-meta-document': currentDocument.name
                },
                body: JSON.stringify(annotationData, null, 2)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to save to Azure: ${response.status} ${errorText}`);
            }
        }

        function rehighlightAnnotation(annotation, oldStatus) {
            // Find and remove the old highlight
            const oldClassName = oldStatus === 'active' ? 'highlight-active' : 'highlight-inactive';
            const newClassName = annotation.status === 'active' ? 'highlight-active' : 'highlight-inactive';
            
            const highlights = document.querySelectorAll(`.${oldClassName}`);
            for (let highlight of highlights) {
                if (highlight.textContent === annotation.text) {
                    // Change the class and styling
                    highlight.className = newClassName;
                    highlight.style.backgroundColor = annotation.status === 'active' ? '#d4edda' : '#f8d7da';
                    highlight.style.border = `2px solid ${annotation.status === 'active' ? '#28a745' : '#dc3545'}`;
                    
                    // Update the click handler
                    highlight.onclick = () => removeAnnotation(annotation.text, annotation.status);
                    break;
                }
            }
        }

        function removeAnnotationById(annotationId) {
            if (confirm('Remove this annotation?')) {
                const annotation = documentAnnotations.find(ann => ann.id === annotationId);
                if (annotation) {
                    // Remove from annotations array
                    documentAnnotations = documentAnnotations.filter(ann => ann.id !== annotationId);
                    
                    // Remove the highlight from the document
                    removeHighlightFromDocument(annotation.text, annotation.status);
                    
                    // Update the display
                    updateAnnotationCount();
                    updateAnnotationsList();
                    
                    // Save changes
                    saveAnnotationsToStorage();
                    
                    console.log('Removed annotation:', annotation);
                    console.log('Remaining annotations:', documentAnnotations.length);

                }
            }
        }

        function removeHighlightFromDocument(text, status) {
            const className = status === 'active' ? 'highlight-active' : 'highlight-inactive';
            const highlights = document.querySelectorAll(`.${className}`);
            
            for (let highlight of highlights) {
                if (highlight.textContent === text) {
                    // Replace the highlight span with plain text
                    const textNode = document.createTextNode(highlight.textContent);
                    highlight.parentNode.replaceChild(textNode, highlight);
                    break;
                }
            }
        }

        function saveAnnotationsToStorage() {
            if (!currentDocument) return;
            
            const allAnnotations = JSON.parse(localStorage.getItem('documentAnnotations')) || {};
            allAnnotations[currentDocument.id] = documentAnnotations;
            localStorage.setItem('documentAnnotations', JSON.stringify(allAnnotations));
        }

        // function scrollToAnnotation(text) {
        //     const highlights = document.querySelectorAll('.highlight-active, .highlight-inactive');
        //     for (let highlight of highlights) {
        //         if (highlight.textContent.includes(text)) {
        //             highlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
        //             highlight.style.boxShadow = '0 0 10px #667eea';
        //             setTimeout(() => {
        //                 highlight.style.boxShadow = '';
        //             }, 2000);
        //             break;
        //         }
        //     }
        // }


        // Replace the scrollToAnnotation function (around line 1950) with this enhanced version:
        function scrollToAnnotation(text) {
            console.log('🔍 Scrolling to annotation:', text);
            
            // Find all highlights in the document
            const highlights = document.querySelectorAll('.highlight-active, .highlight-inactive');
            let foundHighlight = null;
            
            // Look for exact or partial text match
            for (let highlight of highlights) {
                const highlightText = highlight.textContent.trim();
                
                // Try exact match first
                if (highlightText === text) {
                    foundHighlight = highlight;
                    break;
                }
                
                // Try partial match (for truncated text in annotations list)
                if (text.length > 50 && highlightText.includes(text.substring(0, 50))) {
                    foundHighlight = highlight;
                    break;
                }
                
                // Try reverse partial match
                if (highlightText.includes(text) || text.includes(highlightText)) {
                    foundHighlight = highlight;
                    break;
                }
            }
            
            if (foundHighlight) {
                console.log('✅ Found highlight, scrolling to it');
                
                // Scroll to the highlight
                foundHighlight.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'nearest'
                });
                
                // Add visual emphasis with animation
                const originalStyle = {
                    boxShadow: foundHighlight.style.boxShadow,
                    transform: foundHighlight.style.transform,
                    transition: foundHighlight.style.transition
                };
                
                // Apply highlight animation
                foundHighlight.style.transition = 'all 0.5s ease';
                foundHighlight.style.boxShadow = '0 0 20px #667eea, 0 0 40px #667eea';
                foundHighlight.style.transform = 'scale(1.05)';
                
                // Flash effect
                let flashCount = 0;
                const flashInterval = setInterval(() => {
                    foundHighlight.style.opacity = foundHighlight.style.opacity === '0.5' ? '1' : '0.5';
                    flashCount++;
                    
                    if (flashCount >= 6) { // Flash 3 times (6 changes)
                        clearInterval(flashInterval);
                        foundHighlight.style.opacity = '1';
                    }
                }, 200);
                
                // Remove effects after animation
                setTimeout(() => {
                    foundHighlight.style.boxShadow = originalStyle.boxShadow;
                    foundHighlight.style.transform = originalStyle.transform;
                    foundHighlight.style.transition = originalStyle.transition;
                }, 3000);
                
            } else {
                console.warn('❌ Highlight not found for text:', text);
                
                // Show a message to user
                const message = document.createElement('div');
                message.textContent = `Could not locate "${text.substring(0, 30)}..." in the document`;
                message.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: #f8d7da; color: #721c24; padding: 1rem 2rem;
                    border: 1px solid #f5c6cb; border-radius: 8px;
                    font-size: 0.875rem; z-index: 2000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    document.body.removeChild(message);
                }, 3000);
            }
        }

        function toggleAnnotationsPanel() {
            const panel = document.getElementById('annotationsPanel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                updateAnnotationsList();
            }
        }



        // function saveAnnotations() {
        //     if (!currentDocument) return;
            
        //     // Save annotations to localStorage
        //     const allAnnotations = JSON.parse(localStorage.getItem('documentAnnotations')) || {};
        //     allAnnotations[currentDocument.id] = documentAnnotations;
        //     localStorage.setItem('documentAnnotations', JSON.stringify(allAnnotations));
            
        //     // Show success message
        //     const originalText = event.target.textContent;
        //     event.target.textContent = 'Saved!';
        //     event.target.style.background = '#28a745';
            
        //     setTimeout(() => {
        //         event.target.textContent = originalText;
        //         event.target.style.background = '#28a745';
        //     }, 2000);
        // }

        // Replace the saveAnnotations function (around line 1800) with this Azure-enabled version:
        async function saveAnnotations() {
            if (!currentDocument || !currentUser) return;
            
            try {
                // Show saving state
                const saveButton = event.target;
                const originalText = saveButton.textContent;
                saveButton.textContent = 'Saving...';
                saveButton.style.background = '#ffc107';
                saveButton.disabled = true;
                
                // Get Azure config (try both public and admin configs)
                const adminConfigData = localStorage.getItem('azureConfigPublic') || localStorage.getItem('azureConfig');
                if (!adminConfigData) {
                    throw new Error('Azure configuration not found. Please contact administrator.');
                }
                
                const azureConfig = JSON.parse(adminConfigData);
                
                if (!azureConfig.sasToken || !azureConfig.storageAccount || !azureConfig.containerName) {
                    throw new Error('Incomplete Azure configuration. Please contact administrator.');
                }
                
                // Create annotation data with metadata
                const annotationData = {
                    documentId: currentDocument.id,
                    documentName: currentDocument.name,
                    documentBlobName: currentDocument.blobName,
                    userEmail: currentUser.email,
                    userName: currentUser.name,
                    userRole: currentUser.role,
                    annotations: documentAnnotations,
                    lastModified: new Date().toISOString(),
                    version: "1.0",
                    statistics: {
                        totalAnnotations: documentAnnotations.length,
                        activeCount: documentAnnotations.filter(ann => ann.status === 'active').length,
                        inactiveCount: documentAnnotations.filter(ann => ann.status === 'inactive').length,
                        aiGeneratedCount: documentAnnotations.filter(ann => ann.isPreAnnotation).length,
                        userCreatedCount: documentAnnotations.filter(ann => !ann.isPreAnnotation).length,
                        confirmedAiCount: documentAnnotations.filter(ann => ann.source === 'main.py' && !ann.isPreAnnotation).length
                    }
                };
                
                // Create blob path: userEmail/annotations/documentId_annotations.json
                const userFolder = currentUser.email.replace(/[@.]/g, '_'); // Replace @ and . for valid folder names
                const fileName = `${currentDocument.id}_${currentDocument.name.replace(/[^a-zA-Z0-9]/g, '_')}_annotations.json`;
                const blobName = `${userFolder}/annotations/${fileName}`;
                
                // Construct Azure Blob URL with SAS token
                const blobUrl = `https://${azureConfig.storageAccount}.blob.core.windows.net/${azureConfig.containerName}/${blobName}${azureConfig.sasToken}`;
                
                console.log('Saving annotations to Azure:', blobUrl);
                
                // Upload to Azure Blob Storage
                const response = await fetch(blobUrl, {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob',
                        'Content-Type': 'application/json',
                        'x-ms-blob-content-disposition': `inline; filename="${fileName}"`,
                        'x-ms-meta-user': currentUser.email,
                        'x-ms-meta-document': currentDocument.name,
                        'x-ms-meta-annotationcount': documentAnnotations.length.toString()
                    },
                    body: JSON.stringify(annotationData, null, 2)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to save to Azure: ${response.status} ${errorText}`);
                }
                
                // Also save to localStorage as backup
                const allAnnotations = JSON.parse(localStorage.getItem('documentAnnotations')) || {};
                allAnnotations[currentDocument.id] = documentAnnotations;
                localStorage.setItem('documentAnnotations', JSON.stringify(allAnnotations));
                
                // Show success with cloud icon
                saveButton.textContent = '☁️ Saved to Cloud!';
                saveButton.style.background = '#28a745';
                
                console.log('✅ Annotations saved successfully to Azure and localStorage');
                
                // Create user annotation summary file
                await updateUserAnnotationSummary();
                
                setTimeout(() => {
                    saveButton.textContent = originalText;
                    saveButton.style.background = '#28a745';
                    saveButton.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('❌ Error saving annotations:', error);
                
                // Fallback to localStorage only
                const allAnnotations = JSON.parse(localStorage.getItem('documentAnnotations')) || {};
                allAnnotations[currentDocument.id] = documentAnnotations;
                localStorage.setItem('documentAnnotations', JSON.stringify(allAnnotations));
                
                // Show error but indicate localStorage backup worked
                const saveButton = event.target;
                saveButton.textContent = '💾 Saved Locally';
                saveButton.style.background = '#ffc107';
                
                setTimeout(() => {
                    saveButton.textContent = 'Save';
                    saveButton.style.background = '#28a745';
                    saveButton.disabled = false;
                }, 3000);
                
                alert(`☁️ Cloud save failed: ${error.message}\n💾 Annotations saved locally as backup.`);
            }
        }


        // Add this function after the saveAnnotations function:
        async function updateUserAnnotationSummary() {
            if (!currentUser) return;
            
            try {
                // Get Azure config
                const adminConfigData = localStorage.getItem('azureConfigPublic') || localStorage.getItem('azureConfig');
                if (!adminConfigData) return;
                
                const azureConfig = JSON.parse(adminConfigData);
                const userFolder = currentUser.email.replace(/[@.]/g, '_');
                
                // Create user summary data
                const userSummary = {
                    userEmail: currentUser.email,
                    userName: currentUser.name,
                    userRole: currentUser.role,
                    lastActivity: new Date().toISOString(),
                    totalDocumentsAnnotated: 1, // This would be calculated from actual data
                    totalAnnotations: documentAnnotations.length,
                    documentsWorked: [
                        {
                            documentId: currentDocument.id,
                            documentName: currentDocument.name,
                            lastModified: new Date().toISOString(),
                            annotationCount: documentAnnotations.length,
                            activeCount: documentAnnotations.filter(ann => ann.status === 'active').length,
                            inactiveCount: documentAnnotations.filter(ann => ann.status === 'inactive').length
                        }
                    ]
                };
                
                // Save user summary
                const summaryBlobName = `${userFolder}/user_annotation_summary.json`;
                const summaryBlobUrl = `https://${azureConfig.storageAccount}.blob.core.windows.net/${azureConfig.containerName}/${summaryBlobName}${azureConfig.sasToken}`;
                
                await fetch(summaryBlobUrl, {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob',
                        'Content-Type': 'application/json',
                        'x-ms-meta-user': currentUser.email,
                        'x-ms-meta-lastupdate': new Date().toISOString()
                    },
                    body: JSON.stringify(userSummary, null, 2)
                });
                
                console.log('📊 User summary updated successfully');
                
            } catch (error) {
                console.warn('⚠️ Failed to update user summary:', error);
            }
        }

        function closeViewer() {
            document.getElementById('documentViewer').style.display = 'none';
            document.getElementById('annotationsPanel').style.display = 'none';
            currentDocument = null;
            documentAnnotations = [];

            const countElement = document.getElementById('annotationCount');
            if (countElement) {
                countElement.textContent = '0';
            }
        }

        // Initialize annotation mode
        setAnnotationMode('active');
        if (typeof updateAnnotationCount !== 'undefined') {
                updateAnnotationCount();
            }
    </script>

    
</body>
</html>